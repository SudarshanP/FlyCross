<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<title>Title Goes Here</title>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
<script type="text/javascript" src="cross1.json"></script>
<script type="text/javascript" src="coffee-script.js"></script>
<script type="text/javascript" src="handlebars.js"></script>
<script type="text/coffeescript" src="parser.coffee"></script>
<script type="text/javascript" src="punnett.json"></script>
<script type='text/javascript'>
handler = function(data) {
    //$("#response").text(data)
    window.punnet = JSON.parse(data)
    showPunnett(punnett)
}
window.server = {};
server.get = function(path,handler) {
    $.ajax({
      type: 'GET',
      url: path,
      contentType: "application/json",
      processData: false,
      success: handler,
      dataType: "text"
    });
}
server.post = function(path,d,handler) {
    $.ajax({
      type: 'POST',
      url: path,
      contentType: "application/json",
      processData: false,
      data: d,
      success: handler,
      dataType: "text"
    });
}
function Post() {
   url = $('#purl').val();
   d = $('#data').val();
   server.get(url,d,handler);
}
</script>
<script id="entry-template" type="text/x-handlebars-template">
<div>
  {{#if error}}
     <B>{{error}}</B><br>{{frag}}
  {{else}}
     <table border="2">
     {{#each fly}}<tr>
        {{#each this}}<td>
            {{#each this}}<span style="padding:10px;color:green;">
                {{this}}
            </span>{{/each}}
        </td>{{/each}}
     </tr>{{/each}}
     </table>
   {{/if}}
</div>
</script>
<script type="text/coffeescript">
$ ->
   source   = $("#entry-template").html()
   window.template = Handlebars.compile(source)
   #context = {"fly": [[["A","a"],["B","b"],["C","c"]],[["D","d"],["E","e"]]]}
   #alert template(context)
   questionMarks = template({"fly": [[["?"],["?"]],[["?"],["?"]],[["?"],["?"]]]})
   #alert(questionMarks)
   $("#oDad").html(questionMarks);$("#oMom").html(questionMarks);$("#oKid").html(questionMarks)
window.parseDad = -> 
   m = parseFly($('#dad').val(),"M")
   #alert(JSON.stringify(m))
   $('#oDad').html(template(m))
window.parseMom = -> 
   f = parseFly($('#mom').val(),"F")
   $('#oMom').html(template(f))
window.parseKid = -> 
   k = parseFly($('#kid').val())
   $('#oKid').html(template(k))
window.makePunnett = ->
   #alert(inputData["index"])
   server.post("/checkCross",JSON.stringify(inputData),handler)
</script>
<style>
.vvtext {
   -moz-transform:rotate(-270deg); 
   -moz-transform-origin: bottom left;
   -webkit-transform: rotate(-270deg);
   -webkit-transform-origin: bottom left;
   -o-transform: rotate(-270deg);
   -o-transform-origin:  bottom left;
   filter: progid:DXImageTransform.Microsoft.BasicImage(rotation=1);
}
.vtext {
   width:1em;
}
</style>
<script id="punHdrTpl" type="text/x-handlebars-template">
      <tr><td>{{#each fly2Axis}}</td><td class="vtext">{{this}}{{/each}}</td></tr>
</script>
<script id="punRowTpl" type="text/x-handlebars-template">
      <tr><td>{{gamete}}{{#each flies}}</td><td align="center">{{#if warnings}}!{{/if}}&nbsp;{{/each}}</td></tr>
</script>
<script id="punTpl" type="text/x-handlebars-template">
    <table border="2" id='punTable'>
        {{{hdr}}}
        {{#each rows}}{{{this}}}{{/each}}
    </table>
</script>
<script id="legendTpl" type="text/x-handlebars-template">
    <h2>{{title}}</h2>
    <table border="2">
        {{#each rows}}{{{this}}}{{/each}}
    </table>
</script>
<script id="legendRowTpl" type="text/x-handlebars-template">
   <tr><td>{{txt}}</td><td style="background-color:{{color}};">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>
</script>

<script type="text/coffeescript">
window.gColors = ["#FF0000","#00FF00","#0000FF","#FF00FF","#00FFFF","#FFFF00","#70DB93","#5C3317","#9F5F9F","#B5A642","#D9D919","#A62A2A","#8C7853","#A67D3D","#5F9F9F","#D98719","#B87333","#FF7F00","#42426F","#5C4033","#2F4F2F","#4A766E","#4F4F2F","#9932CD","#871F78","#6B238E","#2F4F4F","#97694F","#7093DB","#855E42","#545454","#856363","#D19275","#8E2323","#F5CCB0","#238E23","#CD7F32","#DBDB70","#C0C0C0","#527F76","#93DB70","#215E21","#4E2F2F","#9F9F5F","#C0D9D9","#A8A8A8","#8F8FBD","#E9C2A6","#32CD32","#E47833","#8E236B","#32CD99","#3232CD","#6B8E23","#EAEAAE","#9370DB","#426F42","#7F00FF","#7FFF00","#70DBDB","#DB7093","#A68064","#2F2F4F","#23238E","#4D4DFF","#FF6EC7","#00009C","#EBC79E","#CFB53B","#FF7F00","#FF2400","#DB70DB","#8FBC8F","#BC8F8F","#EAADEA","#D9D9F3","#5959AB","#6F4242","#8C1717","#238E68","#6B4226","#8E6B23","#E6E8FA","#3299CC","#007FFF","#FF1CAE","#00FF7F","#236B8E","#38B0DE","#DB9370","#D8BFD8","#ADEAEA","#5C4033","#CDCDCD","#4F2F4F","#CC3299","#D8D8BF","#99CC32"]
window.pColors = ["#99CC32","#D8D8BF","#CC3299","#4F2F4F","#CDCDCD","#5C4033","#ADEAEA","#D8BFD8","#DB9370","#38B0DE","#236B8E","#00FF7F","#FF1CAE","#007FFF","#3299CC","#E6E8FA","#8E6B23","#6B4226","#238E68","#8C1717","#6F4242","#5959AB","#D9D9F3","#EAADEA","#BC8F8F","#8FBC8F","#DB70DB","#FF2400","#FF7F00","#CFB53B","#EBC79E","#00009C","#FF6EC7","#4D4DFF","#23238E","#2F2F4F","#A68064","#DB7093","#70DBDB","#7FFF00","#7F00FF","#426F42","#9370DB","#EAEAAE","#6B8E23","#3232CD","#32CD99","#8E236B","#E47833","#32CD32","#E9C2A6","#8F8FBD","#A8A8A8","#C0D9D9","#9F9F5F","#4E2F2F","#215E21","#93DB70","#527F76","#C0C0C0","#DBDB70","#CD7F32","#238E23","#F5CCB0","#8E2323","#D19275","#856363","#545454","#855E42","#7093DB","#97694F","#2F4F4F","#6B238E","#871F78","#9932CD","#4F4F2F","#4A766E","#2F4F2F","#5C4033","#42426F","#FF7F00","#B87333","#D98719","#5F9F9F","#A67D3D","#8C7853","#A62A2A","#D9D919","#B5A642","#9F5F9F","#5C3317","#70DB93","#FFFF00","#00FFFF","#FF00FF","#0000FF","#00FF00","#FF0000"]

makeLegend = (title,arr,colors) ->
   legendRowTpl = Handlebars.compile($("#legendRowTpl").html())
   legendTpl = Handlebars.compile($("#legendTpl").html())
   
   tbl = {}
   rows = []
   for txt,i in arr
      tbl[txt] = colors[i%colors.length]
      rows.push legendRowTpl({"txt":txt,"color":tbl[txt]})
   legendTpl({"title":title,"rows":rows})

showLegend = (flyMatrix) ->
   gLegends = []
   pLegends = []
   for row in flyMatrix
      for fly in row
         g = fly.genotype
         idx = gLegends.indexOf g 
         if idx == -1
            fly.gLegendIdx = gLegends.length
            gLegends.push g
         else
            fly.gLegendIdx = idx

         p = fly.phenotype.join " "
         idx = pLegends.indexOf p
         if idx == -1
            fly.pLegendIdx = pLegends.length
            pLegends.push p
         else
            fly.pLegendIdx = idx

   $("#pLegend").html makeLegend("Phenotypes",pLegends,pColors)
   $("#gLegend").html makeLegend("Genotypes",gLegends,gColors)

colorify = ->
   $("#punTable").find("tr").each (i) -> 
      $(this).find("td").each (j) -> 
         if i && j
            fly = punnett["punnetSquare"][i-1][j-1]
            $(this).data({"i":i,"j":j,"fly":fly})
            $(this).attr({"id":"fly_"+(i-1)+"_"+(j-1)})
            $(this).css("background-color":pColors[fly.pLegendIdx]).css("color":gColors[fly.gLegendIdx])
            #alert window.pColors.length+":"+fly.pLegendIdx+":"+pColors[fly.pLegendIdx]
            $(this).hover ->
               $("#status").html $(this).data().i+":"+$(this).data().j+$(this).data().fly.genotype+":"+$(this).attr('id')+" | GIdx:"+$(this).data().fly.gLegendIdx+" | PIdx:"+$(this).data().fly.pLegendIdx+"<BR>Messages: "+$(this).data().fly.warnings

window.showPunnett = (pun) ->
   hdrTpl = Handlebars.compile($("#punHdrTpl").html())
   rowTpl = Handlebars.compile($("#punRowTpl").html())
   punTpl = Handlebars.compile($("#punTpl").html())
   hdrHTML = hdrTpl(pun)
   rows = []
   for r,i in pun["punnetSquare"]
      rows.push rowTpl({"gamete":pun["fly1Axis"][i],"flies":r})
   punHTML = punTpl({"hdr":hdrHTML,"rows":rows})
   $("#out").html(punHTML)
   showLegend(pun["punnetSquare"])
   colorify()  
#$ ->
#   #showPunnett(punnett)
</script>
</head>
<body>
Male: <input type='text' id='dad' value="A,B,(((C)})/D,Y,F;G,Y,H/I,J;+/+"> <input type='submit' value='Ok' onClick='parseDad(); return false' /><br>
<div id='oDad'></div>
<hr>
Female: <input type='text' id='mom' value='P,B,C/D,E,F;G,H/I,J;+/+'> <input type='submit' value='Ok' onClick='parseMom(); return false' /><br>
<div id='oMom'></div>
<hr>
Progeny: <input type='text' id='kid' value='A,B,C/D,E,F;G,H/I,Q;+/+'> <input type='submit' value='Ok' onClick='parseKid(); return false' /><br>
<hr>
<div id="oKid"></div>
<hr>
<input type='submit' value='Make Punnett Square' onClick='parseDad();parseMom();parseKid();makePunnett();return false' />
<hr>
<div id='response'></div>
<div id="status">&nbsp;<br>&nbsp;</div>
<div id="out"></div>
<table>
<tr><td><div id="gLegend"></div></td><td valign="top"><div id="pLegend"></div></td></tr>
</table>
</body>
</html>
